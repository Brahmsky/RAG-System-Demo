# 图谱查询调试日志说明

## 📋 日志结构

图谱查询的完整流程现在会输出详细的调试日志，帮助排查不稳定问题。

---

## 🔍 日志输出流程

### 1. **查询开始标记**
```
============================================================
开始图谱查询流程
============================================================
[DEBUG] 用户问题: <问题内容>
```

### 2. **步骤 1: Schema 检索**

#### 输入提示词
```
--> Text-to-Cypher 步骤 1: 正在检索相关的 Schema 和实体...
[DEBUG] Schema检索提示词:
<完整的提示词内容，包括：>
  - 可用的节点标签
  - 可用的关系类型
  - 所有实体ID列表
  - 用户问题
  - 3个扩展查询
```

#### LLM 返回结果
```
[DEBUG] LLM返回的Schema检索结果:
<原始JSON字符串>

[DEBUG] 解析后的Schema: 
<解析后的Python字典>
```

#### Schema 统计
```
[DEBUG] 相关Schema统计:
  - 节点标签: [标签1, 标签2, ...]
  - 关系类型: [关系1, 关系2, ...]
  - 实体ID: [实体1, 实体2, ...]
```

#### 可能的错误
```
  > 步骤 1 失败: LLM未能返回有效的JSON。错误: <错误信息>
  > 原始返回内容: <LLM原始输出>
```

---

### 3. **步骤 2: Cypher 查询生成**

#### 输入提示词
```
--> Text-to-Cypher 步骤 2: 生成Cypher查询...
[DEBUG] Cypher生成提示词:
<完整的提示词内容，包括：>
  - 相关节点标签
  - 相关关系类型
  - 相关实体ID
  - 用户问题
  - Cypher生成规则和要求
```

#### LLM 返回的 Cypher
```
[DEBUG] LLM原始返回的Cypher:
<原始Cypher查询，可能包含```代码块标记>
```

#### 清理后的 Cypher
```
[DEBUG] 清理后的最终Cypher查询:
<去除代码块标记后的纯Cypher查询>
```

---

### 4. **步骤 3: 执行 Cypher 查询**

#### 执行信息
```
--> Text-to-Cypher 步骤 3: 执行Cypher查询...
[DEBUG] 执行的Cypher:
<实际执行的Cypher语句>
```

#### 成功情况
```
[DEBUG] 查询成功! 返回记录数: <数量>
[DEBUG] 查询结果详情:
[
  {key1: value1, key2: value2, ...},
  {key1: value1, key2: value2, ...},
  ...
]
```

#### 失败情况
```
[ERROR] Cypher执行失败: <错误信息>
[ERROR] 失败的查询语句:
<导致失败的Cypher查询>
```

---

### 5. **查询结束标记**

#### 成功
```
============================================================
图谱查询流程完成 ✓
============================================================
```

#### 失败
```
============================================================
图谱查询流程失败 ✗
============================================================
```

---

## 🐛 如何使用日志排查问题

### 问题1: Schema 检索不准确
**现象**: 返回的节点/关系/实体与问题不相关

**排查步骤**:
1. 检查 `[DEBUG] Schema检索提示词` - 提示词是否清晰？
2. 检查 `扩展3个查询` - 查询扩展是否合理？
3. 检查 `[DEBUG] LLM返回的Schema检索结果` - LLM是否理解了问题？
4. 检查 `所有实体ID` - 相关实体是否在库中？

**优化方向**:
- 调整 `retrieve_relevant_schema()` 的提示词
- 优化查询扩展逻辑
- 检查实体命名是否规范

---

### 问题2: Cypher 生成错误
**现象**: 生成的 Cypher 语法错误或逻辑错误

**排查步骤**:
1. 检查 `[DEBUG] Cypher生成提示词` - 上下文信息是否完整？
2. 检查 `相关节点标签/关系类型/实体ID` - 是否提供了正确的元素？
3. 检查 `[DEBUG] LLM原始返回的Cypher` - 原始生成的查询是否合理？
4. 检查 `[DEBUG] 清理后的最终Cypher查询` - 清理过程是否正确？

**优化方向**:
- 调整 `generate_cypher_query()` 的提示词
- 增加 Cypher 生成示例
- 强化约束条件

---

### 问题3: Cypher 执行失败
**现象**: Neo4j 执行报错

**排查步骤**:
1. 检查 `[ERROR] Cypher执行失败` - 具体错误信息
2. 检查 `[ERROR] 失败的查询语句` - 语句是否有语法错误？
3. 手动在 Neo4j 浏览器中执行该查询，验证错误
4. 检查节点/关系标签是否与数据库实际一致

**优化方向**:
- 修正 Cypher 语法
- 检查图谱 Schema 是否与代码同步
- 增加查询验证逻辑

---

### 问题4: 返回结果为空
**现象**: 查询成功但返回0条记录

**排查步骤**:
1. 检查 `[DEBUG] 执行的Cypher` - 查询条件是否过于严格？
2. 手动在 Neo4j 中执行，看是否真的无数据
3. 检查 `相关实体ID` - 是否命中了实际存在的实体？
4. 尝试放宽查询条件（如使用 CONTAINS 而非精确匹配）

**优化方向**:
- 调整查询策略（从严格到宽松）
- 优化实体匹配逻辑
- 增加模糊匹配

---

## 📊 典型日志示例

### 成功案例
```
============================================================
开始图谱查询流程
============================================================
[DEBUG] 用户问题: 图灵被定成什么罪了？

--> Text-to-Cypher 步骤 1: 正在检索相关的 Schema 和实体...
[DEBUG] Schema检索提示词:
<提示词内容>

扩展3个查询
--- 1.图灵的罪名是什么？
--- 2.图灵被判的具体罪行是什么？
--- 3.图灵被定罪的原因有哪些？

[DEBUG] LLM返回的Schema检索结果:
{"node_labels": ["人物", "罪名"], "relationship_types": ["被判"], "entity_ids": ["人物_艾伦·图灵", "罪名_性悖轨"]}

[DEBUG] 解析后的Schema: {'node_labels': ['人物', '罪名'], 'relationship_types': ['被判'], 'entity_ids': ['人物_艾伦·图灵', '罪名_性悖轨']}

[DEBUG] 相关Schema统计:
  - 节点标签: ['人物', '罪名']
  - 关系类型: ['被判']
  - 实体ID: ['人物_艾伦·图灵', '罪名_性悖轨']

--> Text-to-Cypher 步骤 2: 生成Cypher查询...
[DEBUG] Cypher生成提示词:
<提示词内容>

[DEBUG] LLM原始返回的Cypher:
```cypher
MATCH (p:人物)-[r:被判]->(c:罪名)
WHERE p.id = '人物_艾伦·图灵'
RETURN p.id AS person, type(r) AS relationship, c.id AS crime
```

[DEBUG] 清理后的最终Cypher查询:
MATCH (p:人物)-[r:被判]->(c:罪名)
WHERE p.id = '人物_艾伦·图灵'
RETURN p.id AS person, type(r) AS relationship, c.id AS crime

--> Text-to-Cypher 步骤 3: 执行Cypher查询...
[DEBUG] 执行的Cypher:
MATCH (p:人物)-[r:被判]->(c:罪名)
WHERE p.id = '人物_艾伦·图灵'
RETURN p.id AS person, type(r) AS relationship, c.id AS crime

[DEBUG] 查询成功! 返回记录数: 1
[DEBUG] 查询结果详情:
[{'person': '人物_艾伦·图灵', 'relationship': '被判', 'crime': '罪名_性悖轨'}]

============================================================
图谱查询流程完成 ✓
============================================================
```

---

## 🔧 调试技巧

### 1. **逐步验证**
- 复制 `[DEBUG] Schema检索提示词` 到 LLM，手动验证返回
- 复制 `[DEBUG] Cypher生成提示词` 到 LLM，手动验证生成的 Cypher
- 复制 `[DEBUG] 执行的Cypher` 到 Neo4j 浏览器，手动执行

### 2. **对比分析**
- 对比成功和失败的日志，找出差异点
- 关注提示词的变化对结果的影响

### 3. **数据验证**
- 检查 `所有实体ID` 列表，确认期望的实体在库中
- 检查 `节点标签` 和 `关系类型`，确认与 Neo4j 数据库一致

### 4. **关键字搜索**
- 搜索 `[ERROR]` - 快速定位错误
- 搜索 `[DEBUG]` - 查看详细调试信息
- 搜索 `扩展` - 查看查询扩展效果

---

## 📝 日志输出位置

所有日志都会输出到：
- **控制台** (标准输出)
- 可以通过重定向保存：`python main.py > debug.log 2>&1`

---

## ⚙️ 控制日志级别

目前日志是硬编码的 `[DEBUG]` 级别，未来可以通过配置控制：

```python
# 在 config.py 中添加
graph_debug_level: str = "DEBUG"  # DEBUG | INFO | ERROR
```

---

## 🎯 总结

完整的调试日志可以帮助你：
1. ✅ 了解每一步的输入和输出
2. ✅ 快速定位问题环节（Schema检索/Cypher生成/执行）
3. ✅ 验证 LLM 的理解和生成质量
4. ✅ 优化提示词和查询策略

**现在你可以通过详细的日志来排查图谱查询的不稳定问题了！** 🚀

